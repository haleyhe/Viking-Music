<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.vikings.dao.mapper.UserAccountMapper">
    <cache />
    
    <resultMap id="userMap" type="com.vikings.domain.User">
        <id property="id" column="user_id" />
        <result property="username" column="user_username"/>
        <result property="email" column="user_email"/>
        <result property="zip" column="user_zip"/>
        <result property="dateOfBirth" column="user_birth" javaType="java.util.Date" jdbcType="DATE"/>
        <result property="premium" column="user_premium"/>
        <result property="admin" column="user_admin"/>
        <result property="facebookId" column="user_facebook"/>
    </resultMap>
    
    <select id="userExists" parameterType="com.vikings.domain.User" resultType="boolean">
        SELECT
            CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM
            Users u
        WHERE
            u.username = #{username} OR
            u.emailAddress = #{email}
    </select>
    
    <insert id="registerUser" parameterType="com.vikings.domain.User">
        INSERT IGNORE INTO Users (
            userId,
            username,
            hashedPassword,
            emailAddress,
            zip,
            birthDate
        ) VALUES (
            #{id},
            #{username},
            #{password},
            #{email},
            #{zip},
            #{dateOfBirth}
        );
    </insert>
    
    <select id="processLogin" parameterType="com.vikings.domain.User" resultMap="userMap">
        SELECT
            u.userId as 'user_id',
            u.username as 'user_username',
            u.emailAddress as 'user_email',
            u.zip as 'user_zip',
            u.birthDate as 'user_birth',
            u.premium as 'user_premium',
            u.admin as 'user_admin',
            u.facebookId as 'user_facebook'
        FROM
            Users u
        WHERE
            u.username = #{username} AND
            u.hashedPassword = #{password}
    </select>
    
    <update id="updateUser" parameterType="com.vikings.domain.User">
        UPDATE
            Users u
        SET
            <if test="username != null">
                u.username = #{username},
            </if>
            <if test="password != null">
                u.hashedPassword = #{password},
            </if>
            <if test="email != null">
                u.emailAddress = #{email},
            </if>
            <if test="zip != null">
                u.zip = #{zip},
            </if>
            <if test="dateOfBirth != null">
                u.birthDate = #{dateOfBirth},
            </if>
            <if test="facebookId != null">
                u.facebookId = #{facebookId},
            </if>
            u.premium = #{premium},
            u.admin = #{admin} 
        WHERE
            u.userId = #{id}
        
    </update>
    
</mapper>
